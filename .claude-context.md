# Project Context - Medusa Backend Deployment

## Project Overview
- **Project**: VitaIntegral Store - Medusa Backend
- **Medusa Version**: 2.11.3
- **Node Version**: >= 20
- **Package Manager**: Yarn (with .yarnrc.yml)

## Deployment Goal
Deploy Medusa backend to **Coolify** using:
1. GitHub repository as source
2. Docker-based deployment (Dockerfile build pack)
3. GitHub Actions workflow to trigger Coolify webhook on push

## Current Status

### Completed
- [x] Dockerfile created (based on nexthis/medusa-coolify working example)
- [x] docker-compose.yml created for local testing
- [x] GitHub Actions workflow created (`.github/workflows/docker-build.yml`)
- [x] medusa-config.ts updated with proper configuration
- [x] migrations.sh script created
- [x] package.json updated with predeploy script

### Pending
- [ ] Test deployment on Coolify
- [ ] Configure environment variables in Coolify

## Key Files

| File | Purpose |
|------|---------|
| `Dockerfile` | Multi-stage build based on working medusa-coolify example |
| `medusa-config.ts` | Medusa configuration with workerMode support |
| `migrations.sh` | Database migration script for deployment |
| `package.json` | Added `predeploy` script for migrations |
| `.github/workflows/docker-build.yml` | Triggers Coolify webhook on push |

## Dockerfile Strategy (from nexthis/medusa-coolify)

1. **Build stage**: Install deps, build app â†’ outputs to `.medusa/server/`
2. **Production stage**:
   - Copy `.medusa/` from builder
   - Change WORKDIR to `.medusa/server/`
   - Run `yarn install --production` there
   - Start with `yarn run start`

## Required Environment Variables (for Coolify)

```
DATABASE_URL=postgres://user:pass@host:5432/medusa?ssl=true&sslmode=no-verify
REDIS_URL=redis://user:pass@host:6379/0
STORE_CORS=https://your-storefront.com
ADMIN_CORS=https://your-admin.com
AUTH_CORS=https://your-admin.com
JWT_SECRET=<generate-secure-secret>
COOKIE_SECRET=<generate-secure-secret>
BACKEND_URL=https://api.your-domain.com
PORT=9000
WORKER_MODE=server
DISABLE_ADMIN=false
NODE_ENV=production

# MinIO/S3 File Storage
MINIO_ACCESS_KEY=your-access-key
MINIO_SECRET_KEY=your-secret-key
MINIO_BUCKET=your-bucket-name
MINIO_CDN_URL=https://minio.your-domain.com/bucket-name
MINIO_ENDPOINT=https://minio.your-domain.com
MINIO_REGION=us-east-1
```

## Coolify Configuration

In Coolify, set these as **Build Variables** (not just environment variables) due to:
https://github.com/coollabsio/coolify/issues/1930

## Two Services Architecture (Optional)

For production, you can run two services:

1. **medusa-server**: `WORKER_MODE=server`, `DISABLE_ADMIN=false`
2. **medusa-worker**: `WORKER_MODE=worker`, `DISABLE_ADMIN=true`

---
*Reference: https://github.com/nexthis/medusa-coolify*
